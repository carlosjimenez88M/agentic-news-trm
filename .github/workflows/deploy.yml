name: Model Deployment

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  prepare-models:
    name: Prepare Models for Deployment
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Validate models before deployment
      run: |
        if [ -d models ]; then
          echo "Validating models for deployment..."
          find models -type f \( -name "*.py" -o -name "*.pkl" -o -name "*.h5" -o -name "*.pt" -o -name "*.joblib" \) | wc -l | xargs -I {} echo "Found {} model files"
          find models -type f \( -name "*.py" -o -name "*.pkl" -o -name "*.h5" -o -name "*.pt" -o -name "*.joblib" \)
        else
          echo "No models directory found"
        fi
    
    - name: Package models
      run: |
        if [ -d models ]; then
          mkdir -p dist/models
          cp -r models/* dist/models/ || true
          echo "Models packaged for deployment"
        else
          echo "No models to package"
        fi
    
    - name: Create deployment artifact
      run: |
        tar -czf models-artifact.tar.gz dist/ || echo "No dist directory to package"
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: model-deployment-artifact
        path: models-artifact.tar.gz
        retention-days: 90

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: prepare-models
    if: github.event.inputs.environment == 'staging' || (github.event_name == 'release' && github.event.action == 'published')
    environment:
      name: staging
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: model-deployment-artifact
    
    - name: Extract artifact
      run: |
        tar -xzf models-artifact.tar.gz || echo "No artifact to extract"
    
    - name: Deploy to staging
      run: |
        echo "Deploying agentic models to staging environment..."
        echo "Environment: staging"
        echo "Deployment completed successfully"
    
    - name: Notify deployment status
      if: always()
      run: |
        echo "Staging deployment completed"
        echo "Status: ${{ job.status }}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare-models, deploy-staging]
    if: github.event.inputs.environment == 'production' && github.event_name == 'workflow_dispatch'
    environment:
      name: production
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: model-deployment-artifact
    
    - name: Extract artifact
      run: |
        tar -xzf models-artifact.tar.gz || echo "No artifact to extract"
    
    - name: Deploy to production
      run: |
        echo "Deploying agentic models to production environment..."
        echo "Environment: production"
        echo "Deployment completed successfully"
    
    - name: Notify deployment status
      if: always()
      run: |
        echo "Production deployment completed"
        echo "Status: ${{ job.status }}"

  model-health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: always()
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run health checks
      run: |
        echo "Running post-deployment health checks..."
        python -c "print('✓ Python environment: OK')"
        python -c "import pandas, numpy; print('✓ Dependencies: OK')"
        echo "✓ Model deployment: OK"
        echo "Health check completed successfully"
